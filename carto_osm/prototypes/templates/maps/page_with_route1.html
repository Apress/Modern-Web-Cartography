{% extends 'base_ll.html' %}

{% block title %}{{ name }}{% endblock %}

{% block header %}
<h2>{{ name }}</h2>
{% endblock %}

{% block script %}
<script id="geojson-data" type="application/json">
{{ track_geoJSON | tojson }}
</script>

<script type="text/javascript">
let map;
try {
    const geojsonData = JSON.parse(document.getElementById("geojson-data").textContent);

    map = L.map('map').setView({{ loc }}, {{ zoom }});

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const routeLayer = L.geoJSON(geojsonData, {
        style: {
            color: 'darkgreen', 
            weight: 4
        }
    }).addTo(map);

    let start = null;
    let end = null;
    if (geojsonData.features.length > 0 && geojsonData.features[0].geometry.type === "LineString") {
        const coords = geojsonData.features[0].geometry.coordinates;
        start = coords[0];
        end = coords[coords.length - 1];
    } else if (geojsonData.features.length > 0 && geojsonData.features[0].geometry.type === "MultiLineString") {
        const coords = geojsonData.features[0].geometry.coordinates;
        const startArray = coords[0];
        start = startArray[0];
        const endArray = coords[coords.length - 1];
        end = endArray[endArray.length - 1];
    }

    if (start != null && end != null) {
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        L.marker([start[1], start[0]], {icon: greenIcon}).addTo(map).bindPopup("Enjoy you ride!");
        L.marker([end[1], end[0]], {icon: redIcon}).addTo(map).bindPopup("This is the end");
    }   

    map.fitBounds(routeLayer.getBounds());

} catch(e) {
    if (typeof map !== 'undefined' && map) {map.remove();}
    
    const div = document.getElementById("map")
    if (div) {div.remove();}
        
    const elemDiv = document.createElement('div');
    elemDiv.innerHTML = `<p>${e}</p>`;
    document.body.appendChild(elemDiv);
}
</script>
{% endblock %}