{% extends 'base_ll.html' %}

{% block title %}{{ name }}{% endblock %}

{% block header %}
<h2>{{ name }}</h2>
{% endblock %}

{% block script %}
<script id="geojson-data" type="application/json">
{{ province_geo | safe }}
</script>

<script id="csv-data" type="application/csv">
{{ province_data | safe }}
</script>

<script src="//d3js.org/d3.v7.min.js" charset="utf-8"></script>

<script type="text/javascript">
let map;
try {
    const geojsonData = JSON.parse(document.getElementById("geojson-data").textContent);

    const rawCsvData = document.getElementById("csv-data").textContent
    .replace(/\r/g, '')
    .trim();
    const csvData = d3.csvParse(rawCsvData);

    const csvDataLookup = {};
    csvData.forEach(row => {
        csvDataLookup[row["Province"]] = +row["2024"];
    });

    function getColor(value) {
        return value > 11 ? '#800026' :
            value > 10    ? '#BD0026' :
            value > 9     ? '#E31A1C' :
            value > 8     ? '#FC4E2A' :
            value > 7     ? '#FD8D3C' :
            value > 6     ? '#FEB24C' :
            value > 5     ? '#FED976' :
            value >= 0    ? '#FFEDA0' :
                            '#999999';
    }

    function style(feature) {
        const provinceName = feature.properties.prov_name_en;
        const value = csvDataLookup[provinceName] || -1;
        return {
            fillColor: getColor(value),
            weight: 1,
            opacity: 1,
            color: 'white',
            fillOpacity: 0.7
        };
    }

    map = L.map('map', {zoomSnap: 0.1}).setView([58.5, -96.7], 4);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    function highlightFeature(e) {
        const layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
        }
    }

    let geojson;

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
    }

    function onEachFeature(feature, layer) {
        layer.bindTooltip(`${feature.properties.prov_name_en}: ${csvDataLookup[feature.properties.prov_name_en] ?? 'Unknown'} %`, {
            sticky: true
        });
        layer.on({
            mouseover: function (e) {
                highlightFeature(e);
            },
            mouseout: function(e) {
                resetHighlight(e);
            },
            click: function(e) {
                map.flyToBounds(e.target.getBounds());
            }
        });
    }

    geojson = L.geoJSON(geojsonData, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map)

    const legend = L.control({position: 'bottomleft'});
    legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'info legend');
        const grades = [0, 5, 6, 7, 8, 9, 10, 11];

        div.innerHTML += `<strong>Unemployment rate (%):</strong><br>`;
        for (let i = grades.length - 1; i >= 0; i--) {
            div.innerHTML +=
                `<i style="background:${getColor(grades[i] + 0.1)}"></i> ${grades[i]}${grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+' + '<br>' }`;
        }

        return div;
    };

    legend.addTo(map);

} catch(e) {
    if (typeof map !== 'undefined' && map) {map.remove();}

    const div = document.getElementById("map")
    if (div) {div.remove();}
        
    const elemDiv = document.createElement('div');
    elemDiv.innerHTML = `<p>${e}</p>`;
    document.body.appendChild(elemDiv);
}
</script>
{% endblock %}