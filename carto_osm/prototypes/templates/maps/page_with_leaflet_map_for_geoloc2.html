{% extends 'base_ll.html' %}

{% block title %}{{ name }}{% endblock %}

{% block header %}
<h2>{{ name }}</h2>
{% endblock %}

{% block script %}
<script type="text/javascript">
let map;
fetch("http://ip-api.com/json/")
.then(response => response.json())
.then(data => {
    if (data.status !== "success") throw new Error("IP geolocation error");
    if (!data.lat || !data.lon) throw new Error("Coordinates not found");

    map = L.map('map').setView([data.lat, data.lon], 14);
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    L.marker([data.lat, data.lon]).addTo(map).bindPopup(`<b>I'm here!</b><br>${data.city}, ${data.country}`).openPopup();
})
.catch(error => {
    if (typeof map !== 'undefined' && map) {map.remove();}
     
    const div = document.getElementById("map")
    if (div) {div.remove();}
      
    const elemDiv = document.createElement('div');
    elemDiv.innerHTML = `<p>${error}</p>`;
    document.body.appendChild(elemDiv);
});
</script>
{% endblock %}